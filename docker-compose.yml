version: '3.8'

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: library_backend
    environment:
      # External RDS (you provided)
      DATABASE_URL: "postgresql://postgres:Mahmoud2wagdy@librarymngsys-cls.c5ae4oesoop2.eu-west-1.rds.amazonaws.com:5432/library_db"
      JWT_SECRET_KEY: library-jwt-secret-key-change-in-production-2024
      FLASK_ENV: production
      FLASK_APP: app.py
    ports:
      - "5055:5000"
    volumes:
      - ./backend:/app
      - ./backend/docker:/app/docker
      - backend_uploads:/app/uploads
      - /app/__pycache__
      - /app/.pytest_cache
    # custom entrypoint script will ensure DB exists, run migrations & seed, then start Gunicorn
    command: ["sh", "-c", "chmod +x /app/docker/ensure_db_and_start.sh && /app/docker/ensure_db_and_start.sh"]
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - library_network
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: http://backend:5000/api
    container_name: library_frontend
    environment:
      NEXT_PUBLIC_API_URL: http://backend:5000/api
      NODE_ENV: production
    ports:
      - "3055:3000"
    depends_on:
      - backend
    networks:
      - library_network
    restart: unless-stopped

networks:
  library_network:
    driver: bridge

volumes:
  backend_uploads:
    driver: local