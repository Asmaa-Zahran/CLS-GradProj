version: '3.8'

services:
  # PostgreSQL Database
  db:
    # image: postgres:15-alpine
    container_name: library_db
    environment:
      POSTGRES_DB: library_db
      POSTGRES_USER: library_user
      POSTGRES_PASSWORD: library_password_2024
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backend/database/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql
      - ./backend/database/migrations.sql:/docker-entrypoint-initdb.d/02-migrations.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U library_user -d library_db"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - library_network
    restart: unless-stopped

  # Flask Backend
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: library_backend
    environment:
      # Database connection
      DB_HOST: librarymngsys-cls.c5ae4oesoop2.eu-west-1.rds.amazonaws.com
      DB_PORT: 5432
      DB_NAME: library_db
      DB_USER: postgres
      DB_PASSWORD: Mahmoud2wagdy
      # Alternative: DATABASE_URL format
      DATABASE_URL: postgresql://postgres:Mahmoud2wagdy@librarymngsys-cls.c5ae4oesoop2.eu-west-1.rds.amazonaws.com:5432/library_db
      # JWT Configuration
      JWT_SECRET_KEY: library-jwt-secret-key-change-in-production-2024
      # Flask Configuration
      FLASK_ENV: production
      FLASK_APP: app.py
    ports:
      - "5055:5000"
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - ./backend:/app
      - backend_uploads:/app/uploads
      - /app/__pycache__
      - /app/.pytest_cache
    command: >
      sh -c "
        echo 'Waiting for database to be ready...' &&
        sleep 5 &&
        echo 'Running database migrations...' &&
        python run_migrations.py &&
        echo 'Seeding database with initial data...' &&
        python seed_data.py &&
        echo 'Starting Gunicorn server...' &&
        gunicorn --bind 0.0.0.0:5000 --workers 4 --timeout 120 --access-logfile - --error-logfile - app:app
      "
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - library_network
    restart: unless-stopped

  # Next.js Frontend (Production Mode)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: http://backend:5000/api
    container_name: library_frontend
    environment:
      NEXT_PUBLIC_API_URL: http://backend:5000/api
      NODE_ENV: production
    ports:
      - "3055:3000"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - library_network
    restart: unless-stopped

networks:
  library_network:
    driver: bridge

volumes:
  postgres_data:
    driver: local
  backend_uploads:
    driver: local
